# 在线编辑功能文档

## 📝 概述

VibePoster 的在线编辑功能允许用户在生成海报后，直接在浏览器中对海报进行编辑和调整，无需下载到本地使用专业设计软件。

## ✨ 核心功能

### 1. 编辑模式切换

- **位置**: 左侧控制面板
- **功能**: 在"查看模式"和"编辑模式"之间切换
- **快捷键**: 无
- **说明**: 只有在生成海报后才会显示编辑模式按钮

### 2. 图层选择

- **操作**: 点击画布上的任意图层
- **效果**: 
  - 选中的图层显示蓝色边框
  - 显示 8 个调整大小手柄
  - 属性面板显示该图层的详细信息

### 3. 拖拽移动

- **操作**: 鼠标按住图层并拖动
- **约束**: 
  - 图层不能移出画布范围
  - 锁定的图层无法拖动
- **提示**: 拖动时光标变为"抓取"状态

### 4. 调整大小

- **操作**: 拖动选中图层的 8 个手柄之一
- **手柄位置**:
  - 四角: 同时调整宽度和高度
  - 四边: 只调整对应方向的尺寸
- **约束**: 
  - 最小尺寸: 20px × 20px
  - 不能超出画布边界

### 5. 文本编辑

- **双击文本图层**: 未来版本将支持双击直接编辑
- **当前方式**: 通过属性面板编辑
  - 文本内容
  - 字体大小
  - 颜色
  - 对齐方式
  - 字体粗细

### 6. 图层管理面板

**位置**: 画布右侧

**功能**:
- 显示所有图层列表（从上到下）
- 选择图层
- 显示/隐藏图层 👁️
- 锁定/解锁图层 🔒
- 调整图层顺序 ⬆️⬇️
- 删除图层 🗑️

**快捷操作**:
- 点击图层名称: 选中该图层
- 点击眼睛图标: 切换显示/隐藏
- 点击锁图标: 切换锁定/解锁
- 点击上/下箭头: 调整图层层级
- 点击删除按钮: 删除图层（需确认）

### 7. 属性编辑面板

**位置**: 画布右侧（图层面板左边）

**通用属性**:
- **位置**: X, Y 坐标
- **大小**: 宽度、高度
- **旋转**: 0-360 度
- **透明度**: 0-100%

**文本专属属性**:
- **内容**: 多行文本输入
- **字号**: 8-200px
- **颜色**: 颜色选择器 + 十六进制输入
- **对齐**: 左对齐/居中/右对齐
- **粗细**: 正常/加粗

### 8. 撤销/重做

**工具栏位置**: 画布顶部中央

**功能**:
- ↶ 撤销: 恢复上一步操作
- ↷ 重做: 重新执行已撤销的操作

**快捷键**:
- **撤销**: `Ctrl/Cmd + Z`
- **重做**: `Ctrl/Cmd + Shift + Z` 或 `Ctrl/Cmd + Y`

**历史记录**: 最多保存 50 步操作

### 9. 键盘快捷键

| 快捷键 | 功能 | 说明 |
|--------|------|------|
| `Ctrl/Cmd + Z` | 撤销 | 撤销上一步操作 |
| `Ctrl/Cmd + Shift + Z` | 重做 | 重做已撤销的操作 |
| `Ctrl/Cmd + Y` | 重做 | 重做已撤销的操作（备选） |
| `Delete` 或 `Backspace` | 删除 | 删除选中的图层 |
| `Ctrl/Cmd + C` | 复制 | 复制选中的图层到剪贴板 |
| `Ctrl/Cmd + V` | 粘贴 | 粘贴剪贴板中的图层 |
| `Ctrl/Cmd + D` | 复制 | 快速复制选中的图层 |
| `Escape` | 取消选择 | 取消当前选中的图层 |

**注意**: 在输入框中时，`Delete` 和 `Backspace` 不会删除图层。

## 🎯 使用流程

### 基本编辑流程

1. **生成海报**
   ```
   输入提示词 → 上传图片（可选）→ 点击生成 → 等待完成
   ```

2. **进入编辑模式**
   ```
   点击左侧面板的"编辑模式"按钮
   ```

3. **编辑图层**
   ```
   方法 A: 直接拖拽移动
   方法 B: 拖动手柄调整大小
   方法 C: 打开属性面板精确编辑
   方法 D: 使用图层面板管理图层
   ```

4. **保存结果**
   ```
   切换回"查看模式" → 点击"下载 PSD"
   ```

### 高级编辑技巧

#### 精确对齐

使用属性面板输入精确的 X、Y 坐标值：
- 左上角: (0, 0)
- 居中: (canvas.width/2 - layer.width/2, canvas.height/2 - layer.height/2)

#### 快速复制

1. 选中图层
2. 按 `Ctrl/Cmd + D`
3. 新图层会在原位置偏移 20px 创建

#### 图层排序

- **前置**: 将图层移到最上层，按多次"上移"按钮
- **后置**: 将图层移到最下层，按多次"下移"按钮
- **技巧**: 图层列表中上方的图层在画布中也在上方

## 🏗️ 架构设计

### 组件架构

```
components/
├── editor/                    # 编辑器组件（紧密耦合）
│   ├── EditorCanvas.tsx       # 编辑器主画布
│   ├── EditableLayer.tsx      # 可编辑图层
│   ├── LayerPanel.tsx         # 图层管理面板
│   ├── PropertyPanel.tsx      # 属性编辑面板
│   ├── ToolButton.tsx         # 工具栏按钮
│   └── index.ts               # 导出入口
├── sidebar/                   # 左侧控制区组件
│   ├── CanvasSizeSelector.tsx # 画布尺寸选择
│   ├── DownloadButton.tsx     # 下载按钮
│   ├── PromptInput.tsx        # 提示词输入
│   └── index.ts               # 导出入口
├── poster/                    # 海报展示组件
│   ├── PosterLayer.tsx        # 普通图层渲染
│   └── index.ts               # 导出入口
└── index.ts                   # 统一导出
```

### 状态管理

```typescript
// 编辑器状态
- selectedLayerId: 当前选中的图层 ID
- lockedLayerIds: 锁定的图层 ID 集合
- hiddenLayerIds: 隐藏的图层 ID 集合
- clipboard: 剪贴板中的图层

// 历史记录
- past: 过去的操作记录
- present: 当前状态
- future: 可重做的操作记录
```

### 自定义 Hooks

| Hook | 功能 | 文件 | 说明 |
|------|------|------|------|
| `useEditorState` | 管理编辑器核心状态 | `hooks/useEditorState.ts` | 选中、锁定、隐藏、剪贴板 |
| `useHistory` | 撤销/重做管理 | `hooks/useHistory.ts` | 历史记录栈、时间旅行 |
| `useKeyboardShortcuts` | 键盘快捷键 | `hooks/useKeyboardShortcuts.ts` | 全局事件监听、冲突避免 |
| `useLayerOperations` | 图层操作 | `hooks/useLayerOperations.ts` | 移动、删除、复制、排序 |

### 工具函数

| 函数 | 功能 | 文件 |
|------|------|------|
| `constrainToCanvas` | 确保图层在画布内 | `utils/editorUtils.ts` |
| `calculateResize` | 计算调整大小后的尺寸 | `utils/editorUtils.ts` |
| `findLayerAtPosition` | 查找指定位置的图层 | `utils/editorUtils.ts` |
| `duplicateLayer` | 复制图层 | `utils/editorUtils.ts` |
| `reorderLayer` | 调整图层顺序 | `utils/editorUtils.ts` |

## 🔧 技术实现

### 拖拽实现

```typescript
1. onMouseDown: 记录起始位置，添加全局事件监听
2. onMouseMove: 计算偏移量，更新图层位置
3. onMouseUp: 移除全局事件监听，完成拖拽
```

### 调整大小实现

```typescript
1. 根据手柄方向确定调整逻辑
2. 计算鼠标偏移量
3. 根据方向调整宽高和位置
4. 约束最小尺寸和画布边界
```

### 历史记录实现

```typescript
1. 每次编辑操作后调用 pushHistory
2. 将当前状态保存到 past
3. 清空 future（新操作后无法重做）
4. 限制历史记录数量（最多 50 条）
```

## 📐 设计原则

### 1. 解耦性

- **状态管理**: 独立的 `useEditorState` Hook
- **业务逻辑**: 独立的工具函数库
- **UI 组件**: 职责单一，易于复用

### 2. 类型安全

- 完整的 TypeScript 类型定义
- 严格的类型检查
- 清晰的接口定义

### 3. 用户体验

- 实时反馈（拖拽时立即更新）
- 视觉提示（选中边框、手柄）
- 操作约束（边界检测、最小尺寸）
- 快捷键支持（提高效率）

### 4. 性能优化

- 使用 `useCallback` 避免不必要的重渲染
- 事件委托（全局监听减少监听器数量）
- 条件渲染（隐藏的图层不渲染）

## 🐛 已知限制

1. **双击编辑文本**: 当前通过属性面板编辑，未来版本将支持双击直接编辑
2. **多选**: 暂不支持同时选中多个图层
3. **组合**: 暂不支持将多个图层组合成组
4. **网格吸附**: 暂不支持网格吸附功能
5. **参考线**: 暂不支持辅助对齐参考线
6. **图片替换**: 暂不支持直接替换图片图层的图片

## 🚀 未来计划

- [ ] 双击文本图层直接编辑
- [ ] 多选图层（按住 Shift 或拖拽选择框）
- [ ] 图层分组
- [ ] 网格吸附
- [ ] 智能参考线
- [ ] 图片裁剪和滤镜
- [ ] 更多文本样式（行高、字间距）
- [ ] 导出为 PNG/JPG
- [ ] 云端保存

## 📚 相关文档

- [项目架构](./ARCHITECTURE.md)
- [风格模板系统](./STYLE_TEMPLATES.md)
- [OCR 和图像理解](./OCR_AND_IMAGE_UNDERSTANDING.md)

---

**最后更新**: 2025-01-03
**版本**: v1.0.0


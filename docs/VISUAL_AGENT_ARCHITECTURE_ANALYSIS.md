# Visual Agent æ¶æ„åˆ†æä¸æœåŠ¡å±‚è®¾è®¡

## ğŸ“‹ ä»»åŠ¡ä¹¦è¦æ±‚å›é¡¾

æ ¹æ®ä»»åŠ¡ä¹¦è¦æ±‚ï¼š
- "å®ç°å›¾ç‰‡å†…å®¹æå–åŠŸèƒ½ï¼Œé€šè¿‡OCRåŠLLMæŠ€æœ¯å°†å›¾ç‰‡çš„é£æ ¼ã€å…ƒç´ ã€ä¸»é¢˜ç­‰è½¬åŒ–ä¸ºæ–‡å­—æè¿°"
- "è®¾è®¡ç³»ç»Ÿæ¶æ„ï¼Œæ˜ç¡®å‰ç«¯äº¤äº’ç•Œé¢ä¸åç«¯ç”Ÿæˆå¤„ç†æœåŠ¡çš„åŠŸèƒ½æ¨¡å—åŠæ•°æ®æµè½¬é€»è¾‘"

---

## ğŸ¯ Visual Agent åº”è¯¥æ‰¿æ‹…çš„èŒè´£

### æ ¸å¿ƒå®šä½
**Visual Agent = è§†è§‰æ„ŸçŸ¥ä¸­å¿ƒ + è·¯ç”±å†³ç­–è€…**

### âœ… åº”è¯¥æ‰¿æ‹…çš„èŒè´£

#### 1. è·¯ç”±å†³ç­–ï¼ˆæ ¸å¿ƒèŒè´£ï¼‰
```
è¾“å…¥ï¼šç”¨æˆ·ä¸Šä¼ çš„å›¾ç‰‡ + è®¾è®¡ç®€æŠ¥
è¾“å‡ºï¼šå¤„ç†ç­–ç•¥å†³ç­–

å†³ç­–é€»è¾‘ï¼š
- æƒ…å†µ Aï¼ˆåŒå›¾ï¼‰ï¼šèƒŒæ™¯ + äººç‰© â†’ æŠ å›¾äººç‰©ï¼Œä¿ç•™èƒŒæ™¯
- æƒ…å†µ Bï¼ˆå•å›¾ï¼‰ï¼šäººç‰© â†’ æŠ å›¾äººç‰©ï¼Œæœç´¢èƒŒæ™¯
- æƒ…å†µ Cï¼ˆæ— å›¾ï¼‰ï¼šæœç´¢èƒŒæ™¯
```

#### 2. åè°ƒè§†è§‰å¤„ç†å·¥å…·ï¼ˆç¼–æ’èŒè´£ï¼‰
```
- è°ƒç”¨ OCR + å›¾åƒç†è§£å·¥å…·
- è°ƒç”¨æŠ å›¾å·¥å…·
- è°ƒç”¨ç´ ææœç´¢å·¥å…·
```

#### 3. ç»“æœæ•´åˆä¸ä¼˜åŒ–ï¼ˆå¢å€¼èŒè´£ï¼‰
```
- æ•´åˆ OCR + å›¾åƒç†è§£ç»“æœ
- ç”Ÿæˆä¼˜åŒ–å»ºè®®ï¼ˆæ ‡é¢˜å€™é€‰ã€é…è‰²æ–¹æ¡ˆç­‰ï¼‰
- ä¼˜åŒ–è®¾è®¡ç®€æŠ¥ï¼ˆåˆå¹¶é£æ ¼å…³é”®è¯ï¼‰
```

### âŒ ä¸åº”è¯¥æ‰¿æ‹…çš„èŒè´£

- âŒ å…·ä½“çš„å›¾åƒå¤„ç†ç®—æ³•ï¼ˆåº”åœ¨ `tools/` å±‚ï¼‰
- âŒ ä¸šåŠ¡æµç¨‹æ§åˆ¶ï¼ˆåº”åœ¨ `Workflow` å±‚ï¼‰
- âŒ è®¾è®¡è§„åˆ™æ¨ç†ï¼ˆåº”åœ¨ `KnowledgeService`ï¼‰

---

## ğŸ—ï¸ æœåŠ¡å±‚è®¾è®¡ï¼ˆå·²å®ç°ï¼‰

### å·²å®ç°çš„æœåŠ¡

#### 1. KnowledgeService âœ…

**èŒè´£**ï¼šç»Ÿä¸€ç®¡ç† Knowledge Graph å’Œ RAG

```python
# services/knowledge_service.py

class KnowledgeService:
    """çŸ¥è¯†æœåŠ¡ - ç»Ÿä¸€ç®¡ç† KG + RAG"""
    
    def get_design_context(self, user_prompt, brand_name):
        """è·å–å®Œæ•´çš„è®¾è®¡ä¸Šä¸‹æ–‡"""
        # 1. ä» prompt æå–å…³é”®è¯
        keywords = self.extract_keywords(user_prompt)
        # 2. KG æ¨ç†è®¾è®¡è§„åˆ™
        kg_rules = self.infer_design_rules(keywords)
        # 3. RAG æ£€ç´¢å“ç‰ŒçŸ¥è¯†
        brand_knowledge = self.search_brand_knowledge(...)
        return {...}
    
    def infer_design_rules(self, keywords):
        """KG è®¾è®¡è§„åˆ™æ¨ç†"""
        return self.knowledge_graph.infer_rules(keywords)
    
    def search_brand_knowledge(self, query, brand_name):
        """RAG å“ç‰ŒçŸ¥è¯†æ£€ç´¢"""
        return self.knowledge_base.search(query, ...)
    
    def add_brand_document(self, text, brand_name, category):
        """æ·»åŠ å“ç‰Œæ–‡æ¡£åˆ° RAG"""
        ...
```

**åŸæœ¬å»ºè®®çš„ ImageAnalysisService** â†’ å·²é€šè¿‡ `tools/image_understanding.py` å®ç°

#### 2. RendererService âœ…

**èŒè´£**ï¼šDSL è§£æ + OOP å¸ƒå±€ + Pydantic è½¬æ¢

```python
# services/renderer_service.py

class RendererService:
    """æ¸²æŸ“æœåŠ¡ - DSL åˆ° PosterData"""
    
    def render_poster_from_workflow_state(self, workflow_state):
        """ä»å·¥ä½œæµçŠ¶æ€æ¸²æŸ“æµ·æŠ¥"""
        # 1. è§£æ DSL æŒ‡ä»¤
        dsl_instructions = workflow_state["final_poster"]["dsl_instructions"]
        # 2. æ„å»º OOP å¸ƒå±€
        container = self.parse_dsl_and_build_layout(...)
        # 3. è½¬æ¢ä¸º Pydantic Schema
        poster_data = self.convert_to_pydantic_schema(container, ...)
        return poster_data
```

---

## ğŸ”„ å½“å‰æ¶æ„

### æ¶æ„å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        API Layer                             â”‚
â”‚  /api/generate_multimodal  /api/kg/infer  /api/brand/upload â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      Service Layer                           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  PosterService  â”‚ â”‚KnowledgeService â”‚ â”‚RendererServiceâ”‚  â”‚
â”‚  â”‚                 â”‚ â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚ â”‚               â”‚  â”‚
â”‚  â”‚                 â”‚ â”‚  â”‚    KG     â”‚  â”‚ â”‚  DSL Parser   â”‚  â”‚
â”‚  â”‚                 â”‚ â”‚  â”‚   RAG     â”‚  â”‚ â”‚  OOP Layout   â”‚  â”‚
â”‚  â”‚                 â”‚ â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚ â”‚               â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                       Agent Layer                            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”‚
â”‚  â”‚ Planner â”‚ â”‚ Visual  â”‚ â”‚ Layout  â”‚ â”‚ Critic  â”‚           â”‚
â”‚  â”‚ (KG+RAG)â”‚ â”‚         â”‚ â”‚ (DSL)   â”‚ â”‚         â”‚           â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      Knowledge Layer                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚DesignKnowledgeGraph â”‚  â”‚   BrandKnowledgeBase (RAG)  â”‚   â”‚
â”‚  â”‚    (networkx)       â”‚  â”‚  (sentence-transformers)    â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        Tools Layer                           â”‚
â”‚  vision.py   image_understanding.py   asset_db.py           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### æ•°æ®æµ

```
ç”¨æˆ·è¯·æ±‚
    â”‚
    â–¼
Planner Agent
    â”œâ”€â”€ KnowledgeService.get_design_context()
    â”‚       â”œâ”€â”€ extract_keywords() â†’ ["Tech", "Promotion"]
    â”‚       â”œâ”€â”€ KG.infer_rules() â†’ {colors, fonts, layouts}
    â”‚       â””â”€â”€ RAG.search() â†’ brand knowledge
    â””â”€â”€ LLM â†’ design_brief
    â”‚
    â–¼
Visual Agent
    â”œâ”€â”€ OCR + å›¾åƒç†è§£ (tools/image_understanding.py)
    â”œâ”€â”€ æŠ å›¾ (tools/vision.py)
    â””â”€â”€ ç´ ææœç´¢ (tools/asset_db.py)
    â”‚
    â–¼
Layout Agent
    â”œâ”€â”€ LLM â†’ DSL æŒ‡ä»¤åˆ—è¡¨
    â””â”€â”€ RendererService.render_poster_from_workflow_state()
            â”œâ”€â”€ parse_dsl_and_build_layout() â†’ OOP Container
            â””â”€â”€ convert_to_pydantic_schema() â†’ PosterData
    â”‚
    â–¼
Critic Agent
    â””â”€â”€ å®¡æ ¸ â†’ PASS / FAIL + feedback
```

---

## ğŸ“Š èŒè´£åˆ†å±‚å¯¹æ¯”

| å±‚çº§ | èŒè´£ | ç¤ºä¾‹ |
|------|------|------|
| **API å±‚** | æ¥æ”¶è¯·æ±‚ï¼Œå‚æ•°éªŒè¯ | `routes/poster.py` |
| **æœåŠ¡å±‚** | ä¸šåŠ¡é€»è¾‘ï¼Œæµç¨‹æ§åˆ¶ | `KnowledgeService`, `RendererService` |
| **Agent å±‚** | AI å†³ç­–ï¼Œè°ƒç”¨ LLM | `planner.py`, `visual.py`, `layout.py` |
| **çŸ¥è¯†å±‚** | è§„åˆ™å­˜å‚¨ï¼Œè¯­ä¹‰æ£€ç´¢ | `DesignKnowledgeGraph`, `BrandKnowledgeBase` |
| **å·¥å…·å±‚** | å…·ä½“å®ç°ï¼Œæ— ä¸šåŠ¡é€»è¾‘ | `vision.py`, `asset_db.py` |

---

## âœ… å·²å®ç°çš„å»ºè®®

| åŸå»ºè®® | çŠ¶æ€ | å®ç°ä½ç½® |
|--------|------|---------|
| ImageAnalysisService | âœ… | `tools/image_understanding.py` |
| AssetManagementService | âš ï¸ éƒ¨åˆ† | `tools/asset_db.py` + `vision.py` |
| KnowledgeService | âœ… | `services/knowledge_service.py` |
| RendererService | âœ… | `services/renderer_service.py` |
| CacheService | ğŸ”² | æœªå®ç° |

---

## ğŸ¯ æœªæ¥ä¼˜åŒ–æ–¹å‘

### ä¸­ä¼˜å…ˆçº§

1. **AssetManagementService**
   - ç»Ÿä¸€ç®¡ç†ç´ æå¤„ç†
   - æ·»åŠ ç´ æéªŒè¯åŠŸèƒ½

2. **CacheService**
   - ç¼“å­˜å›¾åƒåˆ†æç»“æœ
   - ç¼“å­˜ç´ ææœç´¢ç»“æœ

### ä½ä¼˜å…ˆçº§

3. **ç›‘æ§å’Œæ—¥å¿—**
   - è®°å½•å›¾åƒåˆ†æè€—æ—¶
   - è®°å½•ç´ ææœç´¢æˆåŠŸç‡

---

## âœ… æ€»ç»“

### Visual Agent å½“å‰èŒè´£
1. âœ… è·¯ç”±å†³ç­–ï¼ˆæ ¸å¿ƒï¼‰
2. âœ… åè°ƒè§†è§‰å¤„ç†å·¥å…·ï¼ˆç¼–æ’ï¼‰
3. âœ… ç»“æœæ•´åˆä¸ä¼˜åŒ–ï¼ˆå¢å€¼ï¼‰

### å·²é›†æˆåˆ°æœåŠ¡å±‚çš„åŠŸèƒ½
1. âœ… **KnowledgeService** - KG + RAG ç»Ÿä¸€ç®¡ç†
2. âœ… **RendererService** - DSL è§£æ + OOP å¸ƒå±€

### æœåŠ¡å±‚çš„å®šä¹‰
**æœåŠ¡å±‚ = ä¸šåŠ¡é€»è¾‘å±‚**ï¼Œä½äº `backend/engine/app/services/`ï¼Œè´Ÿè´£ï¼š
- å°è£…ä¸šåŠ¡é€»è¾‘
- åè°ƒå¤šä¸ªå·¥å…·å’Œ Agent
- æä¾›å¯å¤ç”¨çš„æœåŠ¡
- å¤„ç†ç¼“å­˜ã€éªŒè¯ç­‰æ¨ªåˆ‡å…³æ³¨ç‚¹

---

**æœ€åæ›´æ–°**: 2025-01-08
